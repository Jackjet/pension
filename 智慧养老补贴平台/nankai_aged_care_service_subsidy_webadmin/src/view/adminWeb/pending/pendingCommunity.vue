<template>
  <!-- 待处理  -->
  <div class="page-box">
    <el-menu :default-active="activeIndex" @select="tabNavActive" class="el-menu-demo" mode="horizontal">
      <el-menu-item index="1">补贴业务申请({{num.number1}})</el-menu-item>
      <el-menu-item index="11">评估等级更新({{num.number2}})</el-menu-item>
      <el-menu-item index="12">注销({{num.number3}})</el-menu-item>
      <el-menu-item index="13">区内迁转({{num.number4}})</el-menu-item>
      <el-menu-item index="14">复核变更({{num.number5}})</el-menu-item>
    </el-menu>
    <div class="query-search">
      <el-form :inline="true" :model="formInline" class="demo-form-inline">
        <el-form-item label="办理单号">
          <el-input size="medium" placeholder="办理单号" v-model="formInline.orderNum" clearable>
          </el-input>
        </el-form-item>
        <el-form-item label="老人姓名">
          <el-input size="medium" placeholder="老人姓名" v-model="formInline.name" clearable>
          </el-input>
        </el-form-item>
        <el-form-item label="联系电话">
          <el-input size="medium" placeholder="联系电话" v-model="formInline.phone" clearable>
          </el-input>
        </el-form-item>
        <el-form-item label="身份证号">
          <el-input size="medium" placeholder="身份证号" v-model="formInline.idCard" clearable>
          </el-input>
        </el-form-item>
        <el-form-item v-if="!streetHide" label="所属街道">
          <el-select size="medium" v-model="sqjd1" value-key="id" placeholder="所属街道" @change="streetNameHandle" clearable>
            <el-option v-for="item in streetData" :label="item.name" :value="item" :key="item.id"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item v-if="!communitHide" label="所属社区">
          <el-select size="medium" v-model="sqjd2" value-key="id" placeholder="所属社区" @change="communityIdHandle" clearable>
            <el-option v-for="item in communityData" :label="item.name" :value="item" :key="item.id"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item>
          <el-button size="medium" @click="queryClick">查询</el-button>
        </el-form-item>
      </el-form>
    </div>
    <div class="query-list">
      <TableList :table-data="tableData" v-loading="isSubmitLoading" :table-selection="tableSelection" :table-label="tableHeader" :table-option="tableOpction">
      </TableList>
      <Pagination :total="total" @pageChange="pageChange"></Pagination>
    </div>
    <assessment ref="assessment" @initData="initData"></assessment>
    <examine ref="examine" @initData="initData"></examine>
    <publicity ref="publicity" @initData="initData"></publicity>
  </div>
</template>

<script>
import TableList from "@/components/table";
import assessment from "./assessment.vue";
import examine from "./examine.vue";
import publicity from "./publicity.vue";
import Pagination from "@/components/table/pagination";
import { tokenStr, fileUrl, fileListData, streetList, communityList, userIfo } from "@/api/file.js"
import { subsidyFindAll, publicityCheck } from '@/api/theElderly/list.js';
export default {
  components: {
    assessment,
    examine,
    publicity,
    TableList,
    Pagination
  },
  data() {
    return {
      userType: userIfo().userType,
      activeShow: true,
      activeIndex: '1',
      statusType: '',
      formInline: {
        businessType: '1',
        orderNum: '',//单号
        name: '',//姓名
        idCard: '',//身份证
        phone: '',//手机号
        // status: '',//状态
        homeStreetId: userIfo().streetId,//街道
        homeCommunityId: userIfo().communityId,//社区
        page: 1,
        size: 10,
      },
      tableSelection: {
        key: true,
        type: "",
        detaile: false,
      },
      isSubmitLoading: false,
      tableData: [],
      tableHeader: [
        { label: "老人姓名", list: "name" },
        { label: "所属街道", list: "homeStreetName" },
        { label: "所属社区", list: "homeCommunityName" },
        { label: "性别", list: "sex" },
        { label: "联系电话", list: "phone" },
        { label: "身份证号", list: "idCard" },
        { label: "办理单号", list: "orderNum" },
        {
          type: 'html',
          label: '状态',
          list: 'status',
          code: (row) => {
            if (row.status === 0) {
              return '<span>办理中</span>'
            } else if (row.status === 1) {
              return '<span>完成</span>'
            } else if (row.status === 2) {
              return '<span>已驳回</span>'
            } else if (row.status === 3) {
              return '<span>无须照料</span>'
            }
          }
        },
        { label: "申请时间", list: "createTime" },
        { label: "终审时间（建议）", list: "endTime" },
      ],
      tableOpction: {
        label: "操作",
        width: "220px",
        value: 0,
        options: [
          {
            label: "审核",
            key: 0,
            type: "text",
            show: (row) => {
              // 申请
              if ((row.processNum + '' === '1' || row.processNum + '' === '5') && this.statusType == 0 && this.activeIndex === '1') {
                return true
                // 等级变更
              } else if ((row.processNum + '' === '1') && this.statusType == 0 && this.activeIndex === '11') {
                return true
                // 注销
              } else if ((row.processNum + '' === '1' || row.processNum + '' === '2') && this.statusType == 0 && this.activeIndex === '12') {
                return true
                // 区内迁转
              } else if ((row.processNum + '' === '1' || row.processNum + '' === '2' || row.processNum + '' === '3') && this.statusType == 0 && this.activeIndex === '13') {
                return true
                // 复核变更
              } else if ((row.processNum + '' === '1') && this.statusType == 0 && this.activeIndex === '14') {
                return true
              } else {
                return false
              }
            },
            method: (row) => {
              this.handleToExamine(row);
            },
          },
          {
            label: "详情",
            key: 0,
            type: "text",
            show: (row) => {
              return this.userType != 3
            },
            method: (row) => {
              this.handleDetails(row);
            },
          },
          {
            label: "重新编辑",
            key: 0,
            type: "text",
            show: (row) => {
              return row.processNum == -1 || row.processNum == 0;
            },
            method: (row) => {
              this.handleEdit(row);
            },
          },
          {
            label: "上传公示结果",
            key: 0,
            show: (row) => {
              return row.processNum + '' === '4' && this.statusType == 0 && this.activeIndex === '1' || row.processNum + '' === '3' && this.statusType == 0 && this.activeIndex === '11'
            },
            type: "text",
            method: (row) => {
              this.upPublicity(row);
            },
          },
          // processNum 流程步骤
          // statusType 处理状态 
          // activeIndex 业务类型 
          {
            label: "上传联审结果",
            key: 0,
            show: (row) => {
              return row.processNum + '' === '2' && this.statusType == 0 && this.activeIndex === '1'
            },
            type: "text",
            method: (row) => {
              this.upExamine(row);
            },
          },
          {
            label: "上传评估报告",
            key: 0,
            show: (row) => {
              return row.processNum + '' === '3' && this.statusType == 0 && this.activeIndex === '1' || row.processNum + '' === '2' && this.statusType == 0 && this.activeIndex === '11'
            },
            type: "text",
            method: (row) => {
              this.upAssessment(row);
            },
          },
        ],
      },
      total: 0,
      streetData: [],
      communityData: [],
      sqjd1: "",
      sqjd2: "",
      streetHide: false,
      communitHide: false,
      num: {
        number1: 0,
        number2: 0,
        number3: 0,
        number4: 0,
        number5: 0,
      }
    }
  },
  created() {
    let query = this.$route.query
    let queryType = "", queryProcessType = null;
    if (query.type == '2') {
      queryType = '1';
    }
    if (query.type == 1) {
      queryProcessType = query.processType;
    }

    subsidyFindAll({
      processType: queryProcessType,
      status: queryType,
      businessType: 1,//类型
      homeStreetId: userIfo().streetId,//街道
      homeCommunityId: userIfo().communityId,//社区
    }).then(res => {
      if (res.data.code === 1) {
        this.num.number1 = res.data.data.totalElements;
      }
    })
    subsidyFindAll({
      processType: queryProcessType,
      status: queryType,
      businessType: 11,//类型
      homeStreetId: userIfo().streetId,//街道
      homeCommunityId: userIfo().communityId,//社区
    }).then(res => {
      if (res.data.code === 1) {
        this.num.number2 = res.data.data.totalElements;
      }
    })
    subsidyFindAll({
      processType: queryProcessType,
      status: queryType,
      businessType: 12,//类型
      homeStreetId: userIfo().streetId,//街道
      homeCommunityId: userIfo().communityId,//社区
    }).then(res => {
      if (res.data.code === 1) {
        this.num.number3 = res.data.data.totalElements;
      }
    })
    subsidyFindAll({
      processType: queryProcessType,
      status: queryType,
      businessType: 13,//类型
      homeStreetId: userIfo().streetId,//街道
      homeCommunityId: userIfo().communityId,//社区
    }).then(res => {
      if (res.data.code === 1) {
        this.num.number4 = res.data.data.totalElements;
      }
    })
    subsidyFindAll({
      processType: queryProcessType,
      status: queryType,
      businessType: 14,//类型
      homeStreetId: userIfo().streetId,//街道
      homeCommunityId: userIfo().communityId,//社区
    }).then(res => {
      if (res.data.code === 1) {
        this.num.number5 = res.data.data.totalElements;
      }
    })
  },
  mounted() {
    let query = this.$route.query;
    if (userIfo().streetId) {
      this.formInline.homeStreetId = userIfo().streetId
      this.streetHide = true
    }
    if (userIfo().communityId) {
      this.formInline.homeCommunityId = userIfo().communityId
      this.communitHide = true
    }
    if (query.type == 1) {
      this.statusType = query.processType
      this.formInline.processType = query.processType
    }
    if (this.userType == 3) {
      this.tableHeader.forEach((v, i) => {
        if (v.label == '身份证号') {
          v.label = '户籍地址'
          v.list = 'homeAddress'
        }
      })
    }
    // if (query.name === '待处理') {
    //   this.formInline.status = '0';
    // } else if (query.name === '完成') {
    //   this.formInline.status = '1';
    // }
    if (query.type == '2') {
      this.activeShow = false
      this.activeIndex = query.index
      this.formInline.businessType = query.index
    }
    this.listData();
    // 街道
    streetList().then(res => {
      if (res.data.code === 1) {
        this.streetData = res.data.data.content;
      }
    });
    let id = this.formInline.homeStreetId
    this.communityFun(id);
  },
  methods: {
    initData() {
      this.listData();
    },
    handleEdit(row) {
      if (row.applyType == 1 && this.activeIndex === '1') {
        this.$router.push({
          path: '/business/subsidy',
          query: {
            liveSubsidy: row.liveSubsidy,
            nursingSubsidy: row.nursingSubsidy,
            poorSubsidy: row.poorSubsidy,
            idCard: row.idCard,
            orderNum: row.orderNum
          }
        })
      } else if (row.applyType == 2 && this.activeIndex === '1') {
        this.$router.push({
          path: '/business/salary',
          query: {
            liveSubsidy: row.liveSubsidy,
            nursingSubsidy: row.nursingSubsidy,
            poorSubsidy: row.poorSubsidy,
            idCard: row.idCard,
            orderNum: row.orderNum
          }
        })
      } else if (row.applyType == 1 && this.activeIndex === '11') {
        this.$router.push({
          path: '/assessment/subsidy',
          query: {
            liveSubsidy: row.liveSubsidy,
            nursingSubsidy: row.nursingSubsidy,
            poorSubsidy: row.poorSubsidy,
            idCard: row.idCard,
            orderNum: row.orderNum
          }
        })
      } else if (row.applyType == 2 && this.activeIndex === '11') {
        this.$router.push({
          path: '/assessment/salary',
          query: {
            liveSubsidy: row.liveSubsidy,
            nursingSubsidy: row.nursingSubsidy,
            poorSubsidy: row.poorSubsidy,
            idCard: row.idCard,
            orderNum: row.orderNum
          }
        })
      } else if (row.applyType == 1 && this.activeIndex === '13') {
        this.$router.push({
          path: '/area/transfer',
          query: {
            liveSubsidy: row.liveSubsidy,
            nursingSubsidy: row.nursingSubsidy,
            poorSubsidy: row.poorSubsidy,
            idCard: row.idCard,
            orderNum: row.orderNum
          }
        })
      } else if (row.applyType == 2 && this.activeIndex === '13') {
        this.$router.push({
          path: '/area/home',
          query: {
            liveSubsidy: row.liveSubsidy,
            nursingSubsidy: row.nursingSubsidy,
            poorSubsidy: row.poorSubsidy,
            idCard: row.idCard,
            orderNum: row.orderNum
          }
        })
      } else if (row.applyType == 1 && this.activeIndex === '14') {
        this.$router.push({
          path: '/review/subsidy',
          query: {
            liveSubsidy: row.liveSubsidy,
            nursingSubsidy: row.nursingSubsidy,
            poorSubsidy: row.poorSubsidy,
            idCard: row.idCard,
            orderNum: row.orderNum
          }
        })
      } else if (row.applyType == 2 && this.activeIndex === '14') {
        this.$router.push({
          path: '/review/salary',
          query: {
            liveSubsidy: row.liveSubsidy,
            nursingSubsidy: row.nursingSubsidy,
            poorSubsidy: row.poorSubsidy,
            idCard: row.idCard,
            orderNum: row.orderNum
          }
        })
      } else if (row.applyType == 1 && this.activeIndex === '12') {
        this.$router.push({
          path: '/cancellation/apply',
          query: {
            liveSubsidy: row.liveSubsidy,
            nursingSubsidy: row.nursingSubsidy,
            poorSubsidy: row.poorSubsidy,
            idCard: row.idCard,
            orderNum: row.orderNum
          }
        })
      } else if (row.applyType == 2 && this.activeIndex === '12') {
        this.$router.push({
          path: '/cancellation/home',
          query: {
            liveSubsidy: row.liveSubsidy,
            nursingSubsidy: row.nursingSubsidy,
            poorSubsidy: row.poorSubsidy,
            idCard: row.idCard,
            orderNum: row.orderNum
          }
        })
      }
    },
    // 社区
    communityFun(id) {
      communityList({ streetId: id }).then(res => {
        if (res.data.code === 1) {
          this.communityData = res.data.data.content;
        }
      })
    },
    streetNameHandle(value) {
      // this.formInline.streetId = value.id;
      // this.formInline.streetName = value.name;
      // this.formInline.communityId = "";
      // this.formInline.communityName = "";
      this.formInline.homeStreetId = value.id;
      this.formInline.homeCommunityId = "";
      this.communityFun(value.id);
    },
    communityIdHandle(value) {
      // this.formInline.communityId = value.id;
      // this.formInline.communityName = value.name;
      this.formInline.homeCommunityId = value.id;
    },
    queryClick() {
      this.formInline.page = 1;
      this.formInline.size = 10;
      this.listData();
    },
    tabNavActive(index) {
      this.activeIndex = index;
      this.sqjd1 = "";
      this.sqjd2 = "";
      this.formInline = {
        businessType: index,
        orderNum: '',//单号
        name: '',//姓名
        idCard: '',//身份证
        phone: '',//手机号
        // status: "",//状态
        homeStreetId: userIfo().streetId,//街道
        homeCommunityId: userIfo().communityId,//社区
        page: 1,
        size: 10,
      }
      let query = this.$route.query;
      if (query.type == 1) {
        this.formInline.processType = query.processType
      }
      this.listData();
    },
    listData() {
      let query = this.$route.query
      if (query.type == '2') {
        this.formInline.status = '1';
      }
      subsidyFindAll(this.formInline).then(res => {
        if (res.data.code === 1) {
          this.tableData = res.data.data.content;
          this.total = res.data.data.totalElements;
        } else {
          this.$message.error(res.data.msg);
        }
      })
    },
    pageChange(val) {
      this.formInline.page = val.page;
      this.formInline.size = val.limit
      this.listData();
    },
    handleToExamine(row) {
      this.$router.push({
        path: '/subsidy/toExamine',
        query: {
          id: row.id,
          liveSubsidy: 0,
          nursingSubsidy: 0,
          poorSubsidy: 0
        }
      })
    },
    handleDetails(row) {
      this.$router.push({
        // path: '/information/detail',
        path: '/subsidy/toExamine',
        query: {
          id: row.id,
          liveSubsidy: 0,
          nursingSubsidy: 0,
          poorSubsidy: 0,
          type: "详情"
        }
      })
    },
    upPublicity(row) {
      this.$refs.publicity.open(row.orderNum)
    },
    upExamine(row) {
      this.$refs.examine.open(row.orderNum)
    },
    upAssessment(row) {
      this.$refs.assessment.open(row.orderNum)
    },
  }
}
</script>

<style lang="scss" scoped>
.page-box {
  padding: 20px 50px;
  box-sizing: border-box;
  .query-search {
    margin-top: 20px;
    border-radius: 4px;
    box-shadow: $back-shadow;
    padding: 15px 10px;
  }
  .query-list {
    margin-top: 20px;
  }
}
.query-search .el-form-item {
  margin: 0;
}
</style>
